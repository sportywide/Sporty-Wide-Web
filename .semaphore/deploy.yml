version: v1.0
name: Deploy Pipeline
agent:
    machine:
        type: e1-standard-2
        os_image: ubuntu1804
blocks:
    - name: Bump version
      skip:
          when: "branch != 'release'"
      task:
          secrets:
              - name: git-ssh-keys
          prologue:
              commands:
                  - chmod 400 ~/.ssh/id_rsa
                  - checkout
                  - nvm use
                  - node --version
                  - npm --version
          jobs:
              - name: 'Bump version'
                commands:
                    - git config --global user.email "vdtn359@gmail.com"
                    - git config --global user.name "Tuan Nguyen"
                    - VERSION=$(cat version)
                    - echo $(npx semver $VERSION -i minor) > version
                    - git commit -a -m 'v$VERSION'
                    - VERSION=$(cat version)
                    - git tag -m "v$VERSION" "v$VERSION" -f
                    - git push origin --follow-tags
    - name: Build and push docker images
      skip:
          when: "branch != 'release'"
      task:
          secrets:
              - name: docker-login
          prologue:
              commands:
                  - checkout
          jobs:
              - name: 'Build all'
                commands:
                    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
                    - make pullAll
                    - make buildAll
                    - make pushAll
    - name: Deploy Frontend
      skip:
          when: "branch != 'release'"
      task:
          secrets:
              - name: aws-creds
          prologue:
              commands:
                  - checkout
          jobs:
              - name: 'Deploy Frontend'
                commands:
                    - ./scripts/elb/frontend/deploy.sh
    - name: Deploy Backend
      skip:
          when: "branch != 'release'"
      task:
          secrets:
              - name: aws-creds
          prologue:
              commands:
                  - checkout
          jobs:
              - name: 'Deploy Backend'
                commands:
                    - ./scripts/elb/backend/deploy.sh
