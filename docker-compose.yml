version: '3.5'
services:
    base:
        image: sportywide-base
        build:
            context: .
            dockerfile: Dockerfile
            target: dev
        networks:
            - sportywide-backend
            - sportywide-frontend
    web:
        build:
            context: .
            dockerfile: ./packages/sw-web/Dockerfile
            target: base
        ports:
            - 3000:3000
        entrypoint: npm run dev
        depends_on:
            - base
        labels:
            - 'traefik.frontend.rule=Host:www.sportywidedev.com,sportywidedev.com'
            - 'traefik.port=3000'
        volumes:
            - ./packages/sw-shared:/opt/app/packages/sw-shared
            - ./packages/sw-web:/opt/app/packages/sw-web
            - /opt/app/packages/sw-shared/node_modules
            - /opt/app/packages/sw-web/node_modules
        networks:
            - sportywide-frontend
    api:
        build:
            context: .
            dockerfile: ./packages/sw-api/Dockerfile
            target: base
        ports:
            - 5000:5000
            - 9229:9229
        entrypoint: npm run dev
        labels:
            - 'traefik.frontend.rule=Host:api.sportywidedev.com'
            - 'traefik.port=5000'
        environment:
            WAIT_HOSTS: postgres:5432,redis:6379
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DATABASE: ${POSTGRES_DB}
        depends_on:
            - base
        volumes:
            - ./packages/sw-api:/opt/app/packages/sw-api
            - ./packages/sw-shared:/opt/app/packages/sw-shared
            - ./packages/sw-core:/opt/app/packages/sw-core
            - ./packages/sw-schema:/opt/app/packages/sw-schema
            - /opt/app/packages/sw-shared/node_modules
            - /opt/app/packages/sw-schema/node_modules
            - /opt/app/packages/sw-api/node_modules
            - /opt/app/packages/sw-core/node_modules
        networks:
            - sportywide-backend
    email:
        build:
            context: .
            dockerfile: ./packages/sw-email/Dockerfile
            target: base
        entrypoint: npm run dev
        environment:
            WAIT_HOSTS: redis:6379
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DATABASE: ${POSTGRES_DB}
        depends_on:
            - base
        ports:
            - 9230:9229
        volumes:
            - ./packages/sw-shared:/opt/app/packages/sw-shared
            - ./packages/sw-core:/opt/app/packages/sw-core
            - ./packages/sw-email:/opt/app/packages/sw-email
            - ./packages/sw-schema:/opt/app/packages/sw-schema
            - /opt/app/packages/sw-shared/node_modules
            - /opt/app/packages/sw-core/node_modules
            - /opt/app/packages/sw-email/node_modules
            - /opt/app/packages/sw-schema/node_modules
        networks:
            - sportywide-backend
networks:
    sportywide-frontend:
        external:
            name: sportywide-frontend
    sportywide-backend:
        external:
            name: sportywide-backend
